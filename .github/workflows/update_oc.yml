name: "Update OpenCore binaries"
on:
  workflow_call:

jobs:
  update-oc-bins:
    name: "Update OpenCore binaries"
    runs-on:
      - macos-latest
    steps:
      - name: "Checkout to current repo"
        uses: actions/checkout@v4

      - name: "Download latest OpenCorePkg release"
        uses: robinraju/release-downloader@v1.9
        with:
          repository: "acidanthera/OpenCorePkg"
          latest: true
          filename: "*-RELEASE.zip"
          out-file-path: "oc"
      
      - name: "Unzip OpenCorePkg RELEASE version"
        run: "unzip *.zip"
        working-directory: "oc"
      
      - name: "Update BOOT directory"
        run: "cp -r oc/X64/EFI/BOOT EFI/"

      - name: "Update OpenCore.efi binary"
        run: "cp -r oc/X64/EFI/OC/OpenCore.efi EFI/OC/OpenCore.efi"

      - name: "Update Drivers binaries"
        run: |
          for file in *; do
            if [ -e $GITHUB_WORKSPACE/oc/X64/EFI/OC/Drivers/$file ]
            then
              cp $GITHUB_WORKSPACE/oc/X64/EFI/OC/Drivers/$file $file
            fi
          done
        working-directory: "EFI/OC/Drivers"

      - name: "Update Tools binaries"
        run: |
          if [ -d Tools ]
          then
            for file in Tools; do
              if [ -e $GITHUB_WORKSPACE/oc/X64/EFI/OC/Tools/$file ]
              then
                cp $GITHUB_WORKSPACE/oc/X64/EFI/OC/Tools/$file $file
              fi
            done
          fi
        working-directory: "EFI/OC"

      - name: "Remove oc directory"
        run: "rm -rf oc"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ github.token }}
          commit-message: Updated OpenCore binaries
          body: |
            Updated OpenCore binaries
            - Auto-generated by [create-pull-request][1]
            [1]: https://github.com/peter-evans/create-pull-request
          title: Update OpenCore binaries
          base: master